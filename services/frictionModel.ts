import { MAX_TORQUES } from "./dynamics";

export interface NeuralDebugState {
  inputs: { raw: number; normalized: number };
  layer1: { weights: number[]; bias: number[]; activations: number[] };
  layer2: { weights: number[]; bias: number[]; rawOutput: number };
  output: number;
}

export class BPNetwork {
  IW1_1: number[];
  b1: number[];
  LW2_1: number[];
  b2: number[];
  xoffset: number;
  xgain: number;
  ymin: number;
  yoffset: number;
  ygain: number;
  yymin: number;
  vel_low: number;
  vel_up: number;

  constructor(
    IW1_1: number[],
    b1: number[],
    LW2_1: number[],
    b2: number[],
    xoffset: number,
    xgain: number,
    ymin: number,
    yoffset: number,
    ygain: number,
    yymin: number,
    vel_low: number,
    vel_up: number
  ) {
    this.IW1_1 = IW1_1;
    this.b1 = b1;
    this.LW2_1 = LW2_1;
    this.b2 = b2;
    this.xoffset = xoffset;
    this.xgain = xgain;
    this.ymin = ymin;
    this.yoffset = yoffset;
    this.ygain = ygain;
    this.yymin = yymin;
    this.vel_low = vel_low;
    this.vel_up = vel_up;
  }

  // Sigmoid equivalent as per Python: 2.0 / (1.0 + np.exp(-2.0 * x)) - 1.0
  private sigmoid(x: number): number {
    return 2.0 / (1.0 + Math.exp(-2.0 * x)) - 1.0;
  }

  // (input_data - self.xoffset) * self.xgain + self.ymin
  private input_handle(input: number): number {
    return (input - this.xoffset) * this.xgain + this.ymin;
  }

  // sigmoid(self.b1 + self.IW1_1 @ x1)
  private layer1_handle(x1: number): number[] {
    const a1: number[] = [];
    for (let i = 0; i < this.b1.length; i++) {
        const net = this.b1[i] + this.IW1_1[i] * x1;
        a1.push(this.sigmoid(net));
    }
    return a1;
  }

  // self.b2 + self.LW2_1 @ a1
  private layer2_handle(a1: number[]): number {
    let a2 = this.b2[0];
    for (let i = 0; i < this.LW2_1.length; i++) {
        a2 += this.LW2_1[i] * a1[i];
    }
    return a2;
  }

  // y = (a2 - self.yymin) / self.ygain + self.yoffset
  private output_handle(a2: number): number {
      return (a2 - this.yymin) / this.ygain + this.yoffset;
  }

  public predict(inputScalar: number): number {
    // 1. Clip Input
    const input = Math.max(this.vel_low, Math.min(this.vel_up, inputScalar));

    // 2. Normalize
    const x1 = this.input_handle(input);

    // 3. Layer 1 (Hidden)
    const a1 = this.layer1_handle(x1);

    // 4. Layer 2 (Output)
    const a2 = this.layer2_handle(a1);

    // 5. Denormalize
    const y = this.output_handle(a2);

    return y;
  }

  public getDebugState(inputScalar: number): NeuralDebugState {
    const input = Math.max(this.vel_low, Math.min(this.vel_up, inputScalar));
    const x1 = this.input_handle(input);
    const a1 = this.layer1_handle(x1);
    const a2 = this.layer2_handle(a1);
    const y = this.output_handle(a2);

    return {
      inputs: { raw: inputScalar, normalized: x1 },
      layer1: { weights: this.IW1_1, bias: this.b1, activations: a1 },
      layer2: { weights: this.LW2_1, bias: this.b2, rawOutput: a2 },
      output: y
    };
  }
}

// --- Network Instances (Data provided in Python format) ---

const bp_p1 = new BPNetwork(
  [1.1405047409989708, -1.584380574291916, 1.7021247976400034, 1.923545280262406, 1.9227857317618322, 1.9574744403472977, 1.6833268399664192, -2.41844987387587, -1.7358465212655598, -1.7557127102804688, 1.8338329075504798, -2.266001552422055, 3.238287091000808, -4.807346197154954, 1.594748767926299],
  [-2.233741107435124, 1.6303106210477158, -1.299200781403649, -1.0169290121806915, -0.3236030290605803, -0.4155321400140795, -0.5361222756447545, -0.1220925903893327, -0.49593322863629064, -0.4517470155836348, 0.6060315770032316, -2.4074362783929923, 1.9862574705766491, -4.2144887882294295, 2.281407378189078],
  [-0.5724155374128557, -0.3237036796297491, 0.005157576324166253, 0.4178261825075792, -0.13433261017005887, -0.28141980904503355, 0.024199421923860272, -0.6770465695627783, 0.07477517824855408, 0.054705337533134564, -0.1261005737261523, 2.2957564265032913, 0.7947011758138175, -1.2003465941103497, -1.0640916242735108],
  [1.5607494803527318], 0.8, 0.0201612903225806, -1.0, 80.9507757134649, 0.0266700074961162, -1.0, 0.0, 100.0
);

const bp_n1 = new BPNetwork(
  [6.9024535312998605, -6.288520579157632, -9.03404965270561, -8.68282253446983, -6.304205360330846, 7.431804605770331, -7.199907176291991, 7.1893577435974585, 7.167461234314925, -7.315227877414397, -7.096559883965458, -7.168973187528785, -7.586591804344979, -6.95240235754848, 6.908081133183197],
  [-8.114643665497507, 5.601932401153771, 5.85330878661548, 4.358852023512612, 3.451372098763836, -1.681287872740167, 0.9875772785934774, 0.18546364280554384, 1.1344289628235291, -1.804339031353531, -3.5624382469636426, -4.046784983848361, -4.835642793991979, -6.7836146739559275, 7.443015323525716],
  [-0.9387614614563887, -0.4330955496308807, -0.6603412098031269, -1.0831402287378362, 1.637657304732574, 0.41092073459886574, 0.2651570471540123, 0.19894872335062364, -0.05985503236678014, -0.10028632143710071, -0.21201563106388482, 0.22036783777914382, -0.16946975355558094, -0.31437523140053925, -0.4640847067440319],
  [-0.5750124850654391], -100.0, 0.0201612903225806, -1.0, -154.018526497199, 0.0257617625550239, -1.0, -100.0, 0.0
);

const bp_p2 = new BPNetwork(
  [1.3044232044324926, 0.0855589047465358, -0.01364305695452196, -0.013999779153136143, 0.060854298874430154, 0.0004936715629414832, -0.011638041486240668, 3.017670064779255, -0.0810438681936974, -4.369844240917969, 0.07977215900199433, -2.048084084752627, -2.144365390205549, -0.0992697736798035, -0.08104046338676195],
  [-0.8173780944265101, 0.2349002254266048, 0.021605598641514765, -0.11639061063350363, 0.18153416944320044, -0.055125221101623205, -0.10375360263039847, 0.4081035843122673, -0.30845366873945224, -4.92783910933564, 0.2982327874792742, -0.6050894287220289, -1.80672951687514, -0.07341971860292333, -0.6785345915306359],
  [0.8902162316229503, 0.2558266611816704, 0.017277549688867383, -0.1164693225502856, 0.1938387500060804, -0.053157971222290205, -0.10352228560354762, 0.7317426913509146, -0.33128031112858486, 3.007740214617899, 0.31987789655115334, 1.33665839944816, -1.919030537017642, -0.09577236256956445, -0.8034925607963169],
  [1.3631844467059782], 0.8, 0.0201612903225806, -1.0, 141.726436771555, 0.0260673352649926, -1.0, 0.0, 100.0
);

const bp_n2 = new BPNetwork(
  [-5.774788302030605, 5.919454852453454, 6.419840897729158, 5.1776130357451775, -5.1764294815272045, 6.468346133477757, -6.122446357845024, -5.18759639922938, -5.8648906154489895, -5.707828312246359, -6.448607645708857, -6.133896730903945, -6.438651199080949, 5.690689704409021, -5.814843377260596],
  [5.734551199285175, -4.904469945663095, -3.733833015169409, -3.475175155835722, 2.384263939759008, -2.518896826379428, 0.17734077972699774, -0.39780030989582676, -1.4175062743763702, -2.045525075462979, -2.9530465942162785, -3.362518991769792, -4.145165137231536, 4.296618979516546, -5.137859279937631],
  [1.3864891815514149, 0.8427931930646743, 0.9161350215052164, -0.5409537762330167, 1.1579245169768633, 0.7668962383276383, -0.5441622468630943, 0.6063249260903563, -0.8636435432300497, 1.0632522559709094, -1.3872815895064474, 1.3341786631958408, -1.1161668238023021, -0.5973323835035625, -0.45628884590841157],
  [-0.9246130226807869], -100.0, 0.0201612903225806, -1.0, -157.285312347963, 0.0332579874793879, -1.0, -100.0, 0.0
);

const bp_p3 = new BPNetwork(
  [13.075744840701212, 12.982793569571307, -12.947360773991871, 12.925554612667478, -12.920527986512562, -12.753551887368944, 13.292002626464132, 12.792358973023147, -13.020823998562772, 12.932185758221484, 12.978490580249687, -12.94013587872043, -12.847169332304816, -13.064757723761932, 13.258709583993797, 14.65031047129533, -17.579307904434028, 13.556148633725694],
  [-12.77910337023849, -11.341052186209543, 9.853167364894551, -8.366241469431312, 6.856529246863369, 5.82086084517835, -2.374452818913316, -2.9179908938277133, 1.32304267505666, 1.352681431064856, 1.7513851587500195, -3.847368294323485, -5.498221795961444, -6.60714377381395, 8.54425192755079, 12.456629966146416, -17.584126431238552, 14.191611924802789],
  [0.04443516621756653, -0.038156519333074214, -0.012848101331654553, 0.17839780449645815, 0.1248960163745414, -0.08563903193691492, -0.1391064602884749, 0.2560870805613196, -0.10678608650527897, 0.11955783702638896, -0.053049200913105575, -0.14872589791632487, 0.02995002340533477, -0.047191145404429126, 0.2166873420776504, 0.1771049382303266, -2.3010745060690976, -5.429986193467123],
  [3.149547133595705], 0.8, 0.0201612903225806, -1.0, 188.449050406246, 0.0165000612574283, -1.0, 0.0, 100.0
);

const bp_n3 = new BPNetwork(
  [-13.73044671742684, -13.018940910482403, -11.662591833979523, 7.35118063393535, -11.650366063196072, 11.032286019501962, -9.175478787754024, 10.115921825472062, -10.060744112398154, 10.101073674687454, -10.190363397840395, 10.113739143873888, 9.627608522839092, -10.96086002225391, -9.961632209344065, 10.073316747795603, -9.98900815688015, -9.872050126014141],
  [13.072138190012755, 11.043744175570085, 8.186213539495947, -6.844179501820559, 6.565127336349902, -4.184024577830121, 3.5380787596598258, -1.8166495340342392, 0.6232891009508699, -0.03069281071905383, -1.375089792056298, 3.391556096114642, 4.082153123133603, -4.850519455844544, -7.024615648235532, 7.687349043415098, -8.977338290875615, -10.260622677691599],
  [-1.6424668207592978, -0.95701082988427, -0.3489628034306753, -3.091092476795964, -0.265942313287327, 0.9102286240470332, 0.9820311600996544, 0.1985826672500828, 0.14969069626258663, 0.16750587886506965, -0.08416761998663226, 0.30313169115649446, -0.8312064290060334, -0.6270488832984569, -0.19271970672606858, -0.1840820254110195, -0.14585238996404323, 0.20247642995695248],
  [-0.35156125134937544], -100.0, 0.0201612903225806, -1.0, -384.627251864838, 0.0131746050929798, -1.0, -100.0, 0.0
);

const bp_p4 = new BPNetwork(
  [7.653569808396215, -7.528039007140683, -7.446612325161568, 7.773254269827118, 7.491145897631207, -7.548759749876026, -7.629720911092426, 7.591083047047736, 7.545663491373701, 7.342015052954041, -7.951552870172205, -7.860603721962076, 11.014885294779862, -4.942638549166507, 8.099740069833137],
  [-7.529973758457984, 6.572472222202276, 5.805117555667679, -4.005391794980275, -3.4176610926492588, 2.28661177267687, 1.0036434951381734, 0.19707209971050116, 1.3290332468808017, 2.7163021295111274, -2.343312500018955, -4.3122759969395315, 6.8036264484142, -5.016594741396223, 8.885372390358103],
  [0.37995336494284226, 0.38330417398171857, -0.26480476481570325, -0.010295095822652107, 0.055922587652995376, -0.06027014105395223, -0.06725674462708879, 0.07893610692393904, 0.07952645536620206, 0.0975015947645228, -0.03488954272236001, -0.061142396075990035, 0.07010382153782545, -1.1308776209050315, -1.9207040146712346],
  [1.1864622797694537], 0.8, 0.0201612903225806, -1.0, 175.265596846891, 0.00752243022393725, -1.0, 0.0, 100.0
);

const bp_n4 = new BPNetwork(
  [-5.810320622195106, 8.754190952471076, -8.326319781952318, 7.16437430355546, 7.407343557681438, 7.524861730599189, -7.580171001040706, -7.602965287111143, 7.557963641037444, -7.585711588246459, -7.589417448670244, 7.630651548549242, 7.705578517175845, -7.371958058590321, -7.549198102102657],
  [5.921534403025163, -8.16189503676045, 4.94377745715934, -4.641732144724384, -3.0366281501270405, -2.2942523927042733, 1.140522246471806, 0.19335550324992754, 1.3087973922204614, -2.148434902620285, -3.2364961050783085, 4.254371743318913, 5.274383666224504, -6.76557197296452, -7.618556367105193],
  [1.8952035800269427, 1.0846155655957368, 0.1161314646833694, 0.4213389394303088, 0.13173945670588663, 0.02901485752335319, -0.1097439826077248, -0.04469240025610676, 0.12881787739357997, 0.07300340010543566, -0.14198628781304196, -0.035110252040081946, 0.09666119653916863, -0.07559446490002655, 0.014538031163717583],
  [-0.89050681074974], -100.0, 0.0201612903225806, -1.0, -431.827454037953, 0.00761106237505551, -1.0, -100.0, 0.0
);

const bp_p5 = new BPNetwork(
  [2.218354749737426, -3.5206046541076095, 2.8873994969740617, -5.931365491651703, -3.8794031987346527, -7.711163348562152, -3.3036782765421133, 4.476488680179099, -2.6592160283731827, 2.3836130647269886, -3.085676916189346, 3.2097626074756187, -4.931569530625207, 6.6810010406528315, 7.431896275155654],
  [-2.636290080171524, 2.259706482990706, -1.085775545313421, 2.819926228871047, 1.3500169958605783, 2.34490360269736, 1.161101149170352, -0.5621503824471737, -0.3210296962535377, 0.6551219473514123, -1.1580966618023816, 3.11716070913737, -3.2685934102443146, 5.551802213735109, 7.355401084710573],
  [0.12364340900772607, -0.8505380503294553, -0.8508738979851124, -1.4659379307929337, 2.133815422254976, -1.215634325318665, 1.6887456188504755, 1.3406111828598877, -0.27350081864995407, -0.30545273528215133, -0.611024129040226, -4.177341217590916, -0.7243955413784797, 1.012659441735894, 1.6072720231421302],
  [1.1190232783769614], 0.8, 0.0201612903225806, -1.0, 154.574777315225, 0.00574465314877198, -1.0, 0.0, 100.0
);

const bp_n5 = new BPNetwork(
  [-0.7645813246537772, -1.9264422127650143, -2.1529936779485075, 1.456193230844982, 1.2236120126222025, -1.2183004429302144, 1.1665263819742695, 1.2591501363019204, -1.1922253264002964, 1.2064730598377518, -1.2707489210853542, -1.4072679307957017, -1.5487459862385429, 0.943287830696184, 1.0887829106783145],
  [2.3298878273155057, 2.3697194092729568, 1.7881477539094137, -0.7355957192921531, -0.5786986670215137, 0.011808240329612238, -0.3994974158777772, -0.23091087324001608, -0.23780536353292836, 0.3558468984797203, -0.5057322683673676, -0.5435531164139582, -0.46027547356515214, 1.340512101054249, 1.309734281934809],
  [0.539490621313022, -1.324597069362774, 0.365055569263885, 0.3024410470983626, 0.31664636773167393, 0.004636950957130142, 0.11288458960989513, 0.13448267080906073, 0.0914842465617094, 0.0014853848874758569, -0.04805724406862748, -0.1269676925601568, -0.1368781091262235, 0.08062838875154507, -0.027132102430200405],
  [0.37829719146154156], -100.0, 0.0201612903225806, -1.0, -487.695153178977, 0.00565983717697874, -1.0, -100.0, 0.0
);

const bp_p6 = new BPNetwork(
  [0.8068880985502487, -0.5941857896659967, 0.427295734857573, 0.916981581346382, -1.144476726136775, 4.220990507731344, 0.5246607761842801, -3.2335811115776942, 5.533698563525556, 1.1229442230643993, -2.869883439587623, 0.8119869757047257, 0.3826928416973497, 6.001401000726129, 7.048321816681512],
  [-0.44421011401193417, 0.3037500763495977, -0.30210578087119755, -0.5199930228190431, -0.08600345373419978, -0.6350830269660155, -0.026522950889343564, -0.0018863803515846266, 0.4768824709723381, 0.10079608821760563, -0.7224128581049919, 1.1554664609666676, 0.6419112450218813, 6.734246421083985, 7.0827624868306716],
  [0.47256442873600324, -0.23854433183631832, 0.0508853319207561, 0.6324390913884108, 0.36792924174911207, 0.882146403516384, 0.2921973492811292, 2.1305764007384167, 0.6360724024443455, -0.3825047203474098, -0.6509386843372554, 1.318234448448784, 0.6509432143920157, -5.998034187506006, 2.2947126085657783],
  [2.9106108513307207], 0.8, 0.0134048257372654, -1.0, 155.986816918802, 0.00834057344041458, -1.0, 0.0, 150.0
);

const bp_n6 = new BPNetwork(
  [-8.044995468878435, -9.723053975216711, -7.862778944388897, -8.014363517681216, -8.009723756381915, 7.998925460861568, -8.883274150970744, 7.170447455932507, -9.932953785236613, -8.952196892678556, 8.001982507014644, -7.8658302045490025, -8.107731267560983, 7.797588142835824, 8.06777553881581],
  [8.611738944202793, 9.665978116401943, 6.147791146971766, 4.3988414139176415, 3.2710588456832257, -2.536953174974044, 0.9628386281996586, 0.15713588146785118, -0.28558494825393455, -1.6036330401896968, 3.7084954719152012, -4.881248705240879, -5.655128216245155, 7.181594582137622, 8.017806001829106],
  [3.426884459368924, -1.6990788523630063, -0.17048025354859933, -0.1082557205945088, -0.046447589008777414, 0.0760907009576668, -0.4328188520861404, -1.7974477238214666, -1.1555020581965454, -0.3519060543484086, 0.11524965853057928, -0.005966206173737976, -0.08290387361446384, 0.1518102164971987, 0.07587899613911653],
  [-1.8939154250691173], -150.0, 0.0134048257372654, -1.0, -416.391491807991, 0.00800191165490873, -1.0, -150.0, 0.0
);

export const calculateJointFriction = (jointIdx: number, velocityRadS: number): number => {
  // jointIdx is 0-based
  const j = jointIdx + 1; // Convert to 1-based for the switcher
  
  // 1. Convert input velocity from Rad/s to Degrees/s as per requirement
  const velocityDegS = velocityRadS * (180 / Math.PI);

  let predictedPermille = 0;

  let net: BPNetwork | null = null;
  // Strictly follow Python logic: if input > 0 use Positive net, else Negative net
  if (velocityDegS > 0) {
    switch (j) {
        case 1: net = bp_p1; break;
        case 2: net = bp_p2; break;
        case 3: net = bp_p3; break;
        case 4: net = bp_p4; break;
        case 5: net = bp_p5; break;
        case 6: net = bp_p6; break;
    }
  } else {
    switch (j) {
        case 1: net = bp_n1; break;
        case 2: net = bp_n2; break;
        case 3: net = bp_n3; break;
        case 4: net = bp_n4; break;
        case 5: net = bp_n5; break;
        case 6: net = bp_n6; break;
    }
  }

  if (net) {
      predictedPermille = net.predict(velocityDegS);
  } else {
      predictedPermille = 0;
  }

  // 2. The NN output is the permille (â€°) of maximum torque.
  // We must convert this back to Nm.
  // Friction (Nm) = (Permille / 1000) * MAX_TORQUE_OF_JOINT
  const maxTorque = MAX_TORQUES[jointIdx] || 1; 
  const frictionNm = (predictedPermille / 1000.0) * maxTorque;

  return frictionNm;
};

// EXPORTED HELPER FOR UI VISUALIZATION
export const getNeuralState = (jointIdx: number, velocityRadS: number): NeuralDebugState | null => {
    const j = jointIdx + 1;
    const velocityDegS = velocityRadS * (180 / Math.PI);
    let net: BPNetwork | null = null;
    
    // Choose positive or negative network based on velocity sign (> 0 check)
    if (velocityDegS > 0) {
       switch(j) {
          case 1: net = bp_p1; break;
          case 2: net = bp_p2; break;
          case 3: net = bp_p3; break;
          case 4: net = bp_p4; break;
          case 5: net = bp_p5; break;
          case 6: net = bp_p6; break;
       }
    } else {
       switch(j) {
          case 1: net = bp_n1; break;
          case 2: net = bp_n2; break;
          case 3: net = bp_n3; break;
          case 4: net = bp_n4; break;
          case 5: net = bp_n5; break;
          case 6: net = bp_n6; break;
       }
    }
    
    if (!net) return null;
    return net.getDebugState(velocityDegS);
 };